# よくある質問

# ADRVMIC よくある質問

## USB接続の製品の場合には、下記の点についてお確かめください。

 - 使用しているケーブルがデータ通信可能であるか。
   - 電力供給のみのケーブルであることが多々ございます
 - ブートスイッチ等、ファームウェア書き込みモードになっていないか。
   - 説明書にブートスイッチについての記載がある製品が対象です
 - USBポートから十分な電力が供給されているか。
   - 念の為、PC本体のマザーボード側USBコネクタでお確かめください
 - 同時に接続している機器が干渉していないか。
   - できる限り最小構成での試行をお願い致します

## Q: 使用しないピンについてはどのような設定をすればいいですか

### A: REVIVE USB ADVANCEの出力ピンにつきましては、機能を割り当てないようにすることができます。
ピン番号を選択し、『設定』のプルダウンメニューから『未設定』を選択してください。
REVIVE MICRO、またREVIVE USB ADVANCEのデジタルピンにつきましてはプルアップされているため、特別な処理は必要ございません。

----

# カスタム版 よくある質問

## Q: カスタム版ファームウェアを適用してもチャタリングが発生してしまいました。
### A: サンプリング周期または一致検出回数を変更することでチャタリング対策を強化できます。
ひとまず設定値を以下に変更してください。  
 - デジタル入力：サンプリング周期=10ms、一致検出回数=3回
 - ロータリーエンコーダ設定：一致検出回数=2回
 - アナログ入力：サンプリング周期=50ms
それでも改善しない場合は、さらに数値を増やして適正値を見つけてください。  
あまりに酷いようであれば、スイッチの接続に問題があるかスイッチの故障を疑ってください。  

## Q: ロータリーエンコーダを接続しましたが、動作しません。
### A: インクリメンタル形のA相/B相があるロータリーエンコーダにのみ対応しています。アブソリュート形には対応していません。
インクリメンタル形のロータリーエンコーダを使用している場合は以下を確認してください。  
 - 1相タイプ：B相がないタイプです。対応していません。
 - 2相タイプ：A相/B相の接続先が正しいピンになっていること、接続したピンにチェックを付けて設定していることを確認してください。
  A相はD1、B相はD2というように、必ず隣り合ったピンに接続する必要があります。
 - 3相タイプ：Z相には対応していないため、A相/B相のみ接続してください。

使用する方が多いかもしれませんので特記しますが、EC12E2430803やRES20D-50-201-1は2相タイプですので使用できます。

## Q: 遅延を最小限にする設定をしたいのですが、どうすればよいですか？
### A: チャタリング防止設定の値をすべて1に設定してください。
チャタリング防止機能を無効化できます。  

## Q: カスタム版ファームウェアから公式ファームウェアに戻したいのですが、どうすればよいですか？
### A: 「Writing-Tool」フォルダの公式ドキュメント(Readme.md)に沿って戻してください。
公式設定ツールを使用してもよいですし、カスタム版設定ツールの「Firmware Update」ボタンも使用できます。  
なお、公式ファームウェアのhexファイルは「Firmware」フォルダにあります。  

## Q: チャタリング防止とはどのような仕組みなのでしょうか？
### A: 入力の受信タイミングに間隔を設ける仕組み(=サンプリング)を採用しており、デジタル入力ではON/OFFが連続した時に入力値を反映する仕組み(=一致検出)、アナログ入力では複数回取得した入力値を平均化する仕組み(=平均化処理)を採用することでチャタリング等のノイズを除去しています。
チャタリング防止処理としてはいずれも一般的です。  
例えばデジタル入力において、サンプリング周期=10ms／一致検出回数3回の場合、10msごとに値をチェックし、3回同じ値であれば入力値をUSBの接続先へ流すという処理をすることで、より正確な入力を行います。  
アナログ入力においては、1回の入力値の取得では電圧の変動によるばらつきが大きいため、入力値をサンプリング周期ごとに8回取得し、それらの平均化を行うことで、より正確な入力を行います。  

なお、デジタル入力の一致検出、アナログ入力の平均化処理は公式ファームウェアにも搭載されています。  
デジタル入力の一致検出回数は20回になっており、カスタム版ファームウェアではサンプリング周期と合わせて変更できるようにしています。  
アナログ入力の平均化処理は平均化回数が8回になっており、「A1ピンを8回平均化→A2ピンを8回平均化→……A8ピンを8回平均化」としていた処理の流れをカスタム版ファームウェアで変更し、「A1ピンを平均化→A2ピンを平均化→……A8ピンを平均化」という処理を8回行うようにしています。こうすることでA1～A8ピンから見た平均化処理を行うタイミングにばらつきを持たせ、アナログ入力のサンプリング周期が長くなった場合も遅延が顕著に現れないようにしています。  

#### 使用しているチャタリング防止アルゴリズムの変更点
|  | 公式ファームウェア | カスタム版ファームウェア |
| - | - | - |
| デジタル入力 | 一致検出(20回で固定) | サンプリング方式、一致検出 |
| アナログ入力 | 平均化処理 | サンプリング方式、平均化処理(カスタム版に合わせて改善) |

## Q: サンプリング周期と一致検出回数のデフォルト値の根拠は何ですか？
### A: 実体験に基づいたフィーリングです。
デフォルト設定で賄えるパターンが実はほとんどなのでは？　と感じたので、もしもこの設定でチャタリングが起きたならば設定値を変えてもらおうという思想で作りました。  
参考までに設定値の決め方は以下です。  

#### デジタル入力
カスタム版ファームウェアを使用した個人的な経験では、マイクロスイッチ使用時にはサンプリング周期=3ms(一致検出回数=1回)もしくは2ms(2回)からチャタリングが起こらなくなります。  
経験に基づき、スイッチの劣化も考慮すると4ms(2回)くらいにしておけばいいかな、という感覚で設定しました。  

一般的にマイクロスイッチのチャタリング時間には1～10msの幅があると言われています。  
4ms(2回)の設定ならチャタリング時間=8msまでカバーできるため、おおよそこの程度で間違いはないと思います。  

#### デジタル入力(ロータリーエンコーダ)
サンプリング周期は上記項目に依存するため、一致検出回数について記載します。  
個人的な経験では一致検出回数=2回までは入力を受け取ってくれるのですが、3回以上に設定していくと徐々に反応しなくなってきます。  
これはロータリーエンコーダはマイクロスイッチ等よりもパルス出力が安定しないことによるものなので、あえて無効（=1回）にしています。  

#### アナログ入力について
デジタル入力と同じ平均遅延秒数となるように設定しました。  